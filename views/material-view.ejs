<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= material.title %> â€¢ Learn n8n</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
</head>
<body>
    <header>
      <div class="brand">Learn-n8n</div>
      <div class="right">
        <button id="lang-toggle" class="lang-toggle" data-lang="en">EN</button>
        <details>
          <summary>Profile</summary>
          <div class="menu">
            <div class="profile-row">
              <div class="avatar"></div>
              <div>
                <div class="name"><%= name %></div>
                <div class="muted" id="profile-username"><%= username %></div>
                <div class="tier" id="tier"><%= tierText %></div>
                <div class="instruction" id="instruction"><%= instructionText %></div>
                <div class="progress">
                  <div class="bar"><div class="fill" id="progress-fill" data-width="<%= progressPercent %>"></div></div>
                  <div class="small" id="progress-label"><%= progressLabel %></div>
                </div>
              </div>
            </div>
          </div>
        </details>
        <form class="logout" action="/logout" method="post">
          <button class="btn secondary" type="submit">Logout</button>
        </form>
      </div>
    </header>
    
    <div class="layout-container">
      <aside class="sidebar">
        <nav>
          <div class="sidebar-group">
            <h3 class="sidebar-title">Basic Materials</h3>
            <ul class="sidebar-list" id="materials-sidebar">
              <% if (materialsData.length === 0) { %>
                <li><span class="sidebar-link" style="color: #94a3b8; cursor: default;">No materials yet</span></li>
              <% } else { %>
                <% materialsData.forEach(m => { %>
                  <li><a href="/material/<%= m.id %>" class="sidebar-link <%= material.id === m.id ? 'active' : '' %>"><%= m.title %></a></li>
                <% }); %>
              <% } %>
            </ul>
          </div>
          
          <div class="sidebar-group">
            <h3 class="sidebar-title">Projects</h3>
            <ul class="sidebar-list" id="projects-sidebar">
              <% if (projectsData.length === 0) { %>
                <li><span class="sidebar-link" style="color: #94a3b8; cursor: default;">No projects yet</span></li>
              <% } else { %>
                <% if (!basics) { %>
                  <li><span class="sidebar-link" style="color: #94a3b8; cursor: default; opacity: 0.5;">Complete basics to unlock projects</span></li>
                  <% projectsData.forEach(p => { %>
                    <li><span class="sidebar-link" style="color: #94a3b8; cursor: not-allowed; opacity: 0.5;"><%= p.title %></span></li>
                  <% }); %>
                <% } else { %>
                  <% projectsData.forEach(p => { %>
                    <li><a href="/project/<%= p.id %>" class="sidebar-link"><%= p.title %></a></li>
                  <% }); %>
                <% } %>
              <% } %>
            </ul>
          </div>
        </nav>
      </aside>
      
      <main class="content-area">
        <article class="material-content">
          <header class="material-header">
            <h1><%= material.title %></h1>
            <div class="material-meta">
              <span class="muted"><%= new Date(material.createdAt).toLocaleDateString() %></span>
            </div>
          </header>
          
          <div id="material-content-viewer" 
               data-delta-en='<%- JSON.stringify(material.contentDelta) %>'
               data-delta-kr='<%- JSON.stringify(material.contentDeltaKr || material.contentDelta) %>'></div>
          
      
          
          <% if (material.quizQuestions && material.quizQuestions.length > 0) { %>
            <div style="margin-top: 40px; text-align: center;">
              <% if (material.isCompleted) { %>
                <button id="mark-done-btn" class="btn" style="font-size: 16px; padding: 12px 24px; background: #10b981; cursor: default;" disabled>âœ“ Completed</button>
              <% } else { %>
                <button id="mark-done-btn" class="btn" style="font-size: 16px; padding: 12px 24px;">Mark as Done</button>
              <% } %>
            </div>
          <% } %>
        </article>
      </main>
    </div>
    
    <!-- Quiz Modal -->
    <% if (material.quizQuestions && material.quizQuestions.length > 0 && !material.isCompleted) { %>
      <div id="quiz-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
        <div style="background: white; padding: 32px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
          <h2 style="margin: 0 0 24px;">Quiz Questions</h2>
          <form id="quiz-form">
            <% material.quizQuestions.forEach((q, idx) => { %>
              <div class="quiz-modal-item" data-question-idx="<%= idx %>" style="margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                <h3 class="quiz-question" style="margin: 0 0 16px; font-size: 16px;" 
                    data-question-en="<%= q.question %>"
                    data-question-kr="<%= material.quizQuestionsKr && material.quizQuestionsKr[idx] ? material.quizQuestionsKr[idx].question : q.question %>">
                  Question <%= idx + 1 %>: <%= q.question %>
                </h3>
                <div class="quiz-options-radio">
                  <% q.options.forEach((option, optIdx) => { %>
                    <label class="quiz-option" 
                           style="display: block; padding: 10px; margin-bottom: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; transition: all 0.2s;"
                           data-option-en="<%= option %>"
                           data-option-kr="<%= material.quizQuestionsKr && material.quizQuestionsKr[idx] && material.quizQuestionsKr[idx].options && material.quizQuestionsKr[idx].options[optIdx] ? material.quizQuestionsKr[idx].options[optIdx] : option %>">
                      <input type="radio" name="quiz-q<%= idx %>" value="<%= optIdx %>" style="margin-right: 8px;" required>
                      <span class="quiz-option-text"><%= option %></span>
                    </label>
                  <% }); %>
                </div>
                <div class="quiz-feedback" data-question="<%= idx %>" style="display: none; margin-top: 12px; padding: 8px; border-radius: 4px;"></div>
              </div>
            <% }); %>
            <div id="quiz-message" style="margin-top: 20px; padding: 12px; border-radius: 6px; display: none;"></div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px;">
              <button type="button" id="quiz-close-btn" class="btn secondary">Close</button>
              <button type="submit" id="grade-btn" class="btn">Grade My Answers</button>
              <button type="button" id="reset-btn" class="btn" style="display: none; background: #64748b;">Reset Answers</button>
            </div>
          </form>
        </div>
      </div>
    <% } %>

    <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
    <script>
      // Render Quill Delta content
      const quill = new Quill('#material-content-viewer', {
        theme: 'bubble',
        readOnly: true,
        modules: {
          toolbar: false
        }
      })
      
      // Set progress width
      const progressFill = document.getElementById('progress-fill')
      if (progressFill) {
        progressFill.style.width = progressFill.getAttribute('data-width') + '%'
      }
      
      // Language toggle functionality
      const langToggle = document.getElementById('lang-toggle')
      let currentLang = localStorage.getItem('preferredLang') || 'en'
      
      // Helper function to update quiz questions in modal (defined globally so it can be called from quiz code)
      window.updateQuizLanguage = function(lang) {
        // Update quiz questions
        document.querySelectorAll('.quiz-question').forEach((el, idx) => {
          const questionEn = el.getAttribute('data-question-en')
          const questionKr = el.getAttribute('data-question-kr')
          if (questionEn && questionKr) {
            el.innerHTML = `Question ${idx + 1}: ${lang === 'kr' ? questionKr : questionEn}`
          }
        })
        
        // Update quiz options
        document.querySelectorAll('.quiz-option-text').forEach((el) => {
          const optionEn = el.closest('.quiz-option')?.getAttribute('data-option-en')
          const optionKr = el.closest('.quiz-option')?.getAttribute('data-option-kr')
          if (optionEn && optionKr) {
            el.textContent = lang === 'kr' ? optionKr : optionEn
          }
        })
      }
      
      // Initialize language
      function updateLanguage(lang) {
        currentLang = lang
        localStorage.setItem('preferredLang', lang)
        langToggle.textContent = lang.toUpperCase()
        langToggle.setAttribute('data-lang', lang)
        
        // Update content
        const contentViewer = document.getElementById('material-content-viewer')
        const deltaEn = JSON.parse(contentViewer.getAttribute('data-delta-en'))
        const deltaKr = JSON.parse(contentViewer.getAttribute('data-delta-kr'))
        quill.setContents(lang === 'kr' ? deltaKr : deltaEn)
        
        // Update quiz questions if modal exists
        if (window.updateQuizLanguage) {
          window.updateQuizLanguage(lang)
        }
      }
      
      // Set initial language
      updateLanguage(currentLang)
      
      // Handle toggle click
      langToggle.addEventListener('click', () => {
        const newLang = currentLang === 'en' ? 'kr' : 'en'
        updateLanguage(newLang)
      })
      
      // Render content from data attribute (will be updated by language toggle)
      const contentViewer = document.getElementById('material-content-viewer')
      const contentDelta = JSON.parse(contentViewer.getAttribute('data-delta-en'))
      quill.setContents(contentDelta)
      
      // Quiz functionality
      <% if (material.quizQuestions && material.quizQuestions.length > 0 && !material.isCompleted) { %>
        const quizModal = document.getElementById('quiz-modal')
        const markDoneBtn = document.getElementById('mark-done-btn')
        const quizForm = document.getElementById('quiz-form')
        const gradeBtn = document.getElementById('grade-btn')
        const resetBtn = document.getElementById('reset-btn')
        const quizCloseBtn = document.getElementById('quiz-close-btn')
        const quizMessage = document.getElementById('quiz-message')
        const quizDataEn = <%- JSON.stringify(material.quizQuestions) %>
        const quizDataKr = <%- JSON.stringify(material.quizQuestionsKr || material.quizQuestions) %>
        const getQuizData = () => currentLang === 'kr' ? quizDataKr : quizDataEn
        const materialId = '<%= material.id %>'
        let isGraded = false
        let allCorrect = false
        
        function showQuizModal() {
          quizModal.style.display = 'flex'
          quizModal.style.alignItems = 'center'
          quizModal.style.justifyContent = 'center'
          // Update quiz questions to current language when modal opens
          if (window.updateQuizLanguage) {
            window.updateQuizLanguage(currentLang)
          }
        }
        
        function hideQuizModal() {
          quizModal.style.display = 'none'
        }
        
        function resetQuiz() {
          quizForm.reset()
          isGraded = false
          allCorrect = false
          gradeBtn.style.display = 'inline-block'
          resetBtn.style.display = 'none'
          quizMessage.style.display = 'none'
          document.querySelectorAll('.quiz-feedback').forEach(fb => {
            fb.style.display = 'none'
            fb.textContent = ''
            fb.style.background = ''
            fb.style.color = ''
          })
          document.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.disabled = false
            const label = radio.closest('label')
            label.style.opacity = '1'
            label.style.background = 'white'
            label.style.borderColor = '#e2e8f0'
          })
        }
        
        markDoneBtn.addEventListener('click', showQuizModal)
        quizCloseBtn.addEventListener('click', hideQuizModal)
        resetBtn.addEventListener('click', resetQuiz)
        
        // Close modal on background click
        quizModal.addEventListener('click', (e) => {
          if (e.target.id === 'quiz-modal') hideQuizModal()
        })
        
        quizForm.addEventListener('submit', async (e) => {
          e.preventDefault()
          if (isGraded && !allCorrect) {
            resetQuiz()
            return
          }
          
        const answers = []
        let allAnswersCorrect = true
        const quizData = getQuizData()
        
        quizData.forEach((q, idx) => {
            const selected = document.querySelector(`input[name="quiz-q${idx}"]:checked`)
            const answer = selected ? parseInt(selected.value) : null
            answers.push(answer)
            
            const feedback = document.querySelector(`.quiz-feedback[data-question="${idx}"]`)
            const isCorrect = answer === q.correctAnswer
            
            if (!isCorrect) {
              allAnswersCorrect = false
            }
            
            // Show feedback
            if (feedback) {
              feedback.style.display = 'block'
              if (isCorrect) {
                feedback.textContent = 'âœ“ Correct!'
                feedback.style.background = '#dcfce7'
                feedback.style.color = '#166534'
              } else {
                feedback.textContent = 'âœ— Incorrect'
                feedback.style.background = '#fee2e2'
                feedback.style.color = '#991b1b'
              }
            }
            
            // Update label styles
            if (selected) {
              if (isCorrect) {
                selected.closest('label').style.background = '#dcfce7'
                selected.closest('label').style.borderColor = '#86efac'
              } else {
                selected.closest('label').style.background = '#fee2e2'
                selected.closest('label').style.borderColor = '#fca5a5'
              }
            }
          })
          
          // Disable all inputs
          document.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.disabled = true
            if (!radio.checked) {
              radio.closest('label').style.opacity = '0.6'
            }
          })
          
          isGraded = true
          allCorrect = allAnswersCorrect
          
          if (allAnswersCorrect) {
            // All correct - update database
            try {
              const r = await fetch('/material-complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ materialId })
              })
              
              if (!r.ok) {
                throw new Error('Failed to update progress')
              }
              
              const data = await r.json()
              console.log('Material complete response:', data)
              
              let successMessage = 'ðŸŽ‰ Congratulations! All answers are correct!'
              
              // Check if basics were just unlocked
              if (data.basicsDone === 1 || data.basicsDone === '1') {
                successMessage = 'ðŸŽ‰ Congratulations! You completed all basics! Projects are now unlocked!'
                console.log('Basics unlocked! Reloading page...')
              }
              
              quizMessage.textContent = successMessage
              quizMessage.style.background = '#dcfce7'
              quizMessage.style.color = '#166534'
              quizMessage.style.display = 'block'
              
              gradeBtn.style.display = 'none'
              resetBtn.style.display = 'none'
              
              // Close modal after 2 seconds and reload to update profile
              setTimeout(() => {
                hideQuizModal()
                // Force reload from server (no cache)
                window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now()
              }, 2000)
            } catch (error) {
              console.error('Error updating progress:', error)
              quizMessage.textContent = 'Error updating progress. Please try again.'
              quizMessage.style.background = '#fee2e2'
              quizMessage.style.color = '#991b1b'
              quizMessage.style.display = 'block'
            }
          } else {
            // Some wrong - show error message
            quizMessage.textContent = 'Oops! Please Study the Materials Again :('
            quizMessage.style.background = '#fee2e2'
            quizMessage.style.color = '#991b1b'
            quizMessage.style.display = 'block'
            
            gradeBtn.style.display = 'none'
            resetBtn.style.display = 'inline-block'
          }
        })
      <% } %>
    </script>
</body>
</html>


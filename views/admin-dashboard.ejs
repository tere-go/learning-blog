<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard â€¢ Learn n8n</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <header>
      <div class="brand">Learn-n8n</div>
      <div class="right">
        <form class="logout" action="/logout" method="post" style="display: inline;">
          <button class="btn secondary" type="submit">Logout</button>
        </form>
      </div>
    </header>
    
    <main class="admin-wrap">
        <h1>Admin Dashboard</h1>
        
        <section class="table-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0;">Materials</h2>
                <a href="/material-editor" class="btn">Create New Material</a>
            </div>
            <div id="materials-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Writer</th>
                            <th>Created</th>
                            <th>Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (materials.length === 0) { %>
                            <tr><td colspan="6" class="table-empty">No materials found</td></tr>
                        <% } else { %>
                            <% materials.forEach(m => { %>
                                <tr>
                                    <td><%= m.id.substring(0, 8) %>...</td>
                                    <td><%= m.title %></td>
                                    <td><%= m.writer %></td>
                                    <td><%= new Date(m.created_at).toLocaleString() %></td>
                                    <td><%= new Date(m.updated_at).toLocaleString() %></td>
                                    <td>
                                        <button class="btn delete-material-btn" data-id="<%= m.id %>" data-title="<%= m.title.replace(/"/g, '&quot;') %>" style="background: #dc2626; padding: 6px 12px; font-size: 13px;">Delete</button>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </section>
        
        <section class="table-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0;">Projects</h2>
                <a href="/project-editor" class="btn">Create New Project</a>
            </div>
            <div id="projects-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Created</th>
                            <th>Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (projects.length === 0) { %>
                            <tr><td colspan="6" class="table-empty">No projects found</td></tr>
                        <% } else { %>
                            <% projects.forEach(p => { %>
                                <tr>
                                    <td><%= p.id.substring(0, 8) %>...</td>
                                    <td><%= p.title %></td>
                                    <td><%= p.writer %></td>
                                    <td><%= new Date(p.created_at).toLocaleString() %></td>
                                    <td><%= new Date(p.updated_at).toLocaleString() %></td>
                                    <td>
                                        <button class="btn delete-project-btn" data-id="<%= p.id %>" data-title="<%= p.title.replace(/"/g, '&quot;') %>" style="background: #dc2626; padding: 6px 12px; font-size: 13px;">Delete</button>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </section>
    </main>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; padding: 24px; border-radius: 10px; max-width: 400px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <h3 style="margin: 0 0 12px;">Confirm Delete</h3>
            <p id="modal-message" style="margin: 0 0 20px; color: #64748b;">Are you sure you want to delete this item?</p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="modal-cancel" class="btn secondary" style="margin: 0;">Cancel</button>
                <button id="modal-confirm" class="btn" style="margin: 0; background: #dc2626;">Delete</button>
            </div>
        </div>
    </div>
    
    <script>
      let pendingDelete = null;
      
      function showModal(message, onConfirm) {
        document.getElementById('modal-message').textContent = message;
        const modal = document.getElementById('confirm-modal');
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        pendingDelete = onConfirm;
      }
      
      function hideModal() {
        document.getElementById('confirm-modal').style.display = 'none';
        pendingDelete = null;
      }
      
      document.getElementById('modal-cancel').onclick = hideModal;
      document.getElementById('modal-confirm').onclick = () => {
        if (pendingDelete) {
          pendingDelete();
          hideModal();
        }
      };
      
      // Close modal on background click
      document.getElementById('confirm-modal').onclick = (e) => {
        if (e.target.id === 'confirm-modal') hideModal();
      };
      
      // Delete functions
      async function deleteMaterial(id, title) {
        try {
          const r = await fetch(`/material-delete/${id}`, { method: 'DELETE' });
          if (!r.ok) {
            const err = await r.json().catch(() => ({ error: 'Delete failed' }));
            alert(err.error || 'Delete failed');
            return;
          }
          location.reload();
        } catch (e) {
          alert('Failed to delete material');
        }
      }
      
      async function deleteProject(id, title) {
        try {
          const r = await fetch(`/project-delete/${id}`, { method: 'DELETE' });
          if (!r.ok) {
            const err = await r.json().catch(() => ({ error: 'Delete failed' }));
            alert(err.error || 'Delete failed');
            return;
          }
          location.reload();
        } catch (e) {
          alert('Failed to delete project');
        }
      }
      
      // Set up event listeners for delete buttons
      document.querySelectorAll('.delete-material-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const title = this.getAttribute('data-title');
          showModal(`Are you sure you want to delete material: ${title}?`, () => deleteMaterial(id, title));
        });
      });
      
      document.querySelectorAll('.delete-project-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const title = this.getAttribute('data-title');
          showModal(`Are you sure you want to delete project: ${title}?`, () => deleteProject(id, title));
        });
      });
    </script>
</body>
</html>

